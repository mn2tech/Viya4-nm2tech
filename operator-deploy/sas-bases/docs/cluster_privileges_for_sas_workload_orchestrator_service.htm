<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <link rel="stylesheet" type="text/css" href="sas.css"/>
        <title>Cluster Privileges for SAS Workload Orchestrator Service</title>
    </head>
    <body>
        <h1 id="140228097294144cluster-privileges-for-sas-workload-orchestrator-service">Cluster Privileges for SAS Workload Orchestrator Service</h1>
<h2 id="140228097294144overview">Overview</h2>
<p>SAS Workload Orchestrator Service is an advanced scheduler that integrates with SAS Launcher. SAS recommends adding this overlay to allow
the SAS Workload Orchestrator service account to retrieve the following node and pod information so that your deployment will run optimally.</p>
<ul>
<li>
<p>Node presence. This tells us whether the node is known by the Kubernetes server. If the node information cannot be accessed, SAS Workload Orchestrator assumes the node is viable from a status point of view even though kubelet might be dead.</p>
</li>
<li>
<p>Node allocatable cores and memory. These are used to determine how much memory and how many cores are available to use for scheduling. If the node information cannot be accessed, SAS Workload Orchestrator only knows what the hardware contains, not what is available to Kubernetes to use for pods. Only kubelet knows those amounts.</p>
</li>
<li>
<p>Node labels (referred to by SAS Workload Orchestrator as &lsquo;host properties&rsquo;). If the node information cannot be accessed:</p>
<ul>
<li>SAS Workload Orchestrator does not have host properties to use with host types.<ul>
<li>SAS Workload Orchestrator uses host properties to assign a node to a host type. When host properties are not available, the host type must be selected another way, such as matching host name using regex values.</li>
<li>SAS Workload Orchestrator uses the host properties as node labels to set the nodeAffinity for pods that it scales. This setting is required to generate a scaling pod for a specific node pool. If there are no host properties, the scaling pod will only have the label &lsquo;workload.sas.com/class=compute&rsquo; which could match more than one node pool.</li>
</ul>
</li>
<li>SAS Workload Orchestrator cannot check to see whether the node has the &lsquo;workload.sas.com/class&rsquo; label set to &lsquo;compute&rsquo; so that it can schedule pods to the node. Instead, SAS Workload Orchestrator assumes it can schedule pods to any node where the SAS Workload Orchestrator DaemonSet pod is running.</li>
</ul>
</li>
<li>
<p>Node &lsquo;unschedulable&rsquo; value. This is used to determine whether a node has been cordoned off so that no pods can be scheduled on it. If the node information cannot be accessed, SAS Workload Orchestrator still schedules pods to a cordoned-off node.
  <strong>Note:</strong> The ability for SAS Workload Manager to recognize that a node has been cordoned is new in release 2024.01.</p>
</li>
<li>
<p>Resources used by pods from other namespaces running on the node. This is used to reduce the cores and memory available for scheduling. If the pod information about pods from other namespaces cannot be accessed, the amount of cores and memory available for scheduling is incorrect. This causes OutOfmemory and OutOfcpu launch errors.</p>
</li>
</ul>
<p>If you choose not to allow the ClusterRoleBinding, you must perform the following tasks:</p>
<ul>
<li>
<p>Prevent pods from other namespaces from running on the compute nodes that are used by the current namespace. This can be done by making both of these changes:</p>
<ul>
<li>Have a node pool that has a special label for each namespace.</li>
<li>Change the pod templates for a deployment to require that special node label in the nodeAffinity.</li>
</ul>
</li>
<li>
<p>Group hosts by host name using a regular expression instead of host properties. The cloud vendor might generate node host names based in part on the node pool name.</p>
</li>
<li>
<p>Close hosts in SAS Workload Orchestrator instead of using Kubernetes cordoning action.</p>
</li>
<li>
<p>Limit the number of pods, jobs, or both that can be started on a node so that the total-pod-resource requirements fit within the nodes&rsquo; available memory and cores.</p>
</li>
<li>
<p>Prepare for kubelet to stop responding when it has a problem.</p>
</li>
</ul>
<p>Without the ability to get node labels as host properties, SAS Workload Orchestrator cannot allocate a new node from the correct node pool when a pod triggers a scale-up. As stated above, SAS Workload Orchestrator uses the host properties (that is, node labels) of the host type to be scaled to create the scaling pod&rsquo;s nodeAffinity information. Without the host properties, the only label in the nodeAffinity section will be &lsquo;workload.sas.com/class=compute&rsquo;. If you have only one deployment in a cluster and only one scalable node pool for the deployment, this is not a problem. If you have multiple deployments and each deployment has a scalable host type or multiple scalable host types, this is a problem because the node information cannot be accessed.</p>
<h2 id="140228097294144instructions">Instructions</h2>
<h3 id="140228097294144enable-the-clusterrole">Enable the ClusterRole</h3>
<p>The ClusterRole and ClusterRoleBinding are enabled by adding the file to the resources block of the base kustomization.yaml file
(<code>$deploy/kustomization.yaml</code>). Here is an example:</p>
<pre class="highlight"><code class="language-yaml">resources:
...
- sas-bases/overlays/sas-workload-orchestrator</code></pre>

<h3 id="140228097294144disable-the-clusterrole">Disable the ClusterRole</h3>
<p>To disable the ClusterRole and ClusterRoleBinding:</p>
<ol>
<li>
<p>Remove <code>sas-bases/overlays/sas-workload-orchestrator</code> from the resources block of the
base kustomization.yaml file (<code>$deploy/kustomization.yaml</code>). This also ensures that the
ClusterRole option will not be applied in future Kustomize builds.</p>
</li>
<li>
<p>Perform the following command to remove the ClusterRoleBinding from the namespace:</p>
<pre class="highlight"><code class="language-bash">kubectl delete clusterrolebinding sas-workload-orchestrator-&lt;your namespace&gt;</code></pre>

</li>
<li>
<p>Perform the following command to remove the ClusterRole from the cluster.</p>
<pre class="highlight"><code class="language-bash">kubectl delete clusterrole sas-workload-orchestrator</code></pre>

</li>
</ol>
<h2 id="140228097294144build">Build</h2>
<p>After you configure Kustomize, continue your SAS Viya platform deployment as documented.</p>
    </body>
</html>