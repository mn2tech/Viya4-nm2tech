apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PGUpgrade
metadata:
  name: sas-crunchy-cds-postgres-upgrade
  labels:
    sas.com/admin: sas-crunchy-cds-postgres-pgupgrade-cr
    sas.com/pgupgrade-cr: sas-crunchy-cds-postgres-pgupgrade-cr
    workload.sas.com/class: stateful
spec:
  image: sas-crunchy5-upgrade
  imagePullSecrets:
    - name: sas-image-pull-secrets
  postgresClusterName: sas-crunchy-cds-postgres
  fromPostgresVersion: 12
  toPostgresVersion: 16
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: "1"
      memory: 8Gi
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 1
        preference:
          matchExpressions:
          - key: workload.sas.com/class
            operator: In
            values:
            - stateful
      - weight: 1
        preference:
          matchExpressions:
          - key: workload.sas.com/class
            operator: NotIn
            values:
            - compute
            - cas
            - stateless
            - connect
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.azure.com/mode
            operator: NotIn
            values:
            - system
  tolerations:
    - effect: NoSchedule
      key: workload.sas.com/class
      operator: Equal
      value: stateful
    - effect: NoSchedule
      key: workload.sas.com/class
      operator: Equal
      value: stateless