<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <link rel="stylesheet" type="text/css" href="sas.css"/>
        <title>State Transfer for CAS Server for the SAS Viya Platform</title>
    </head>
    <body>
        <h1 id="140053167644432state-transfer-for-cas-server-for-the-sas-viya-platform">State Transfer for CAS Server for the SAS Viya Platform</h1>
<h2 id="140053167644432overview">Overview</h2>
<p>This directory contains files to Kustomize your SAS Viya platform deployment to enable state transfers.
Enabling state transfers allows the sessions, tables, and state of a running CAS server to be preserved
between a running CAS server and a new CAS server instance which will be started as part of the CAS server upgrade.</p>
<p><strong>Note:</strong> You cannot enable both CAS auto-restart and state transfer in the same SAS Viya platform deployment.  If you have already
enabled auto-restart, disable it before continuing.</p>
<h2 id="140053167644432instructions">Instructions</h2>
<h3 id="140053167644432edit-the-kustomizationyaml-file">Edit the kustomization.yaml File</h3>
<p>To add the new CAS server to your deployment:</p>
<ol>
<li>
<p>Add a reference to the <code>state-transfer</code> overlay to the resources block of the base
kustomization.yaml file (<code>$deploy/kustomization.yaml</code>).  This overlay adds a PVC to the deployment
to store the temporary state data during a state transfer.  This PVC is mounted to both the source and target system
and must be large enough to hold all session and global tables that are loaded at transfer time.
If you need to increase the size of the transfer PVC, consider using the <code>cas-modify-pvc-storage.yaml</code> example file.</p>
<pre class="highlight"><code class="language-yaml">resources:
...
- sas-bases/overlays/cas-server/state-transfer</code></pre>

</li>
<li>
<p>Add the state-transfer transformer to enable the state transfer feature to the deployment</p>
<p><pre class="highlight"><code class="language-yaml">transformers:
...
- sas-bases/overlays/cas-server/state-transfer/support-state-transfer.yaml</code></pre>
3. Determine the method to transfer the state. The model &lsquo;readonly&rsquo; has a shorter
window where the server is unresponsive. However, during the transfer, attempts to alter
or create global tables will fail. The model &lsquo;suspend&rsquo; has a longer window
where the server is unresponsive, and attempts to alter or create global tables will
wait until the transfer is complete.</p>
<p>The default state transfer model is &lsquo;suspend&rsquo;. If you want to specify a model at
deployment time, copy the <code>$deploy/sas-bases/examples/cas/configure/cas-add-environment-variables.yaml</code>
file to <code>$deploy/site-config/cas/configure/cas-add-environment-variables.yaml</code>, if you have
not already done so. In the copied file, change the value of CASCFG_STATETRANSFERMODEL
to the model you want to use. The model can also be changed by altering the CAS server option stateTransferModel.</p>
<p>Here is an example of the code used to set the state transfer model to &lsquo;readonly&rsquo;.</p>
<pre class="highlight"><code class="language-yaml">...
patch: |-
  - op: add
    path: /spec/controllerTemplate/spec/containers/0/env/-
    value:
      name: CASCFG_STATETRANSFERMODEL
      value: "readonly"</code></pre>

</li>
<li>
<p>Decide if you want to limit the amount of data in individual sessions to be transferred.
The server will be unresponsive while session tables are transferred between the
original server and the new server. The length of this period of unresponsiveness can be
managed by setting the MAXSESSIONTRANSFERSIZE server option. Any session that has more data
loaded than the value of this option will not be transferred to the new session. The default
behavior is to impose no limit. Smaller values of this option can reduce the amount of time
that the server is unresponsive during a state transfer.</p>
<p>If you want to specify a limit at deployment time, copy the
<code>$deploy/sas-bases/examples/cas/configure/cas-add-environment-variables.yaml</code>file to
<code>$deploy/site-config/cas/configure/cas-add-environment-variables.yaml</code>, if you have
not already done so. In the copied file, set the environment variable CASCFG_MAXSESSIONTRANSFERSIZE.</p>
<p>Here is an example of the code used to set the session transfer size limit to 10 million bytes.</p>
<pre class="highlight"><code class="language-yaml">...
patch: |-
  - op: add
    path: /spec/controllerTemplate/spec/containers/0/env/-
    value:
      name: CASCFG_MAXSESSIONTRANSFERSIZE
      value: "10000000"</code></pre>

</li>
<li>
<p>If you have changed the values CASCFG_STATETRANSFERMODEL or CASCFG_MAXSESSIONTRANSFERSIZE, add
a reference to the cas-add-environment-variables.yaml file to the transformers block of the base
kustomization.yaml file (<code>$deploy/kustomization.yaml</code>). Here is an example:</p>
<pre class="highlight"><code class="language-yaml">transformers:
...
- site-config/cas/configure/cas-add-environment-variables.yaml</code></pre>

<p>If you have already made some configuration changes for CAS, this entry may already exist
 in the transformers block.</p>
</li>
</ol>
<h2 id="140053167644432build">Build</h2>
<p>After you configure Kustomize, continue your SAS Viya platform deployment as documented.</p>
    </body>
</html>